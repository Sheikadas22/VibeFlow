<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∂ Seu Player de M√∫sica Avan√ßado</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Vari√°veis de Tema (Default: Dark) */
        :root {
            /* Cores de Fundo (Modo Escuro Padr√£o) */
            --bg-dark: #121212;
            --bg-medium: #181818;
            --bg-light: #282828;

            /* Cores de Fundo (Modo Claro - Apenas se tema-mode for 'light') */
            --bg-light-main: #f0f0f0;
            --bg-light-medium: #ffffff;
            --bg-light-dark: #e0e0e0;
            
            /* Cores de Texto */
            --color-text: #ffffff;
            --color-subtext: #b3b3b3;
            --color-text-dark: #000000;

            /* Cores de Acento (Customiz√°vel pelo usu√°rio) */
            --color-primary: #1DB954; /* Valor padr√£o, ser√° alterado via JS */
            --color-red: #ff4d4d;
            --color-yellow: #FFC300; 

            /* Cor de Fundo Principal Aplicada */
            --main-background: var(--bg-dark);
            --secondary-background: var(--bg-medium);
            --tertiary-background: var(--bg-light);
            --current-text-color: var(--color-text);
            --current-subtext-color: var(--color-subtext);
        }

        /* Aplica√ß√£o do Tema Claro */
        body.light-mode {
            --main-background: var(--bg-light-main);
            --secondary-background: var(--bg-light-dark);
            --tertiary-background: var(--bg-light-medium);
            --current-text-color: var(--color-text-dark);
            --current-subtext-color: #555555;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: var(--main-background); 
            color: var(--current-text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* SCROLLBAR CUSTOMIZADA */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: var(--secondary-background); }


        /* LAYOUT PRINCIPAL (TopBar + Main + Sidebar + Player) */
        .top-bar {
            height: 60px; background-color: var(--secondary-background); display: flex;
            justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); z-index: 10;
        }
        .top-bar-left {
            display: flex; align-items: center; gap: 15px;
        }
        .premium-btn {
            background-color: var(--color-yellow); color: #121212; font-weight: bold;
            padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer;
            text-transform: uppercase; font-size: 0.8em; transition: transform 0.1s;
        }
        .premium-btn:hover { transform: scale(1.05); }
        .premium-btn.active { background-color: var(--color-primary); color: white; cursor: default; }

        /* Bot√µes de A√ß√£o no Top Bar */
        #settings-btn, .user-profile .material-icons {
            background: none; border: none; color: var(--current-subtext-color); 
            font-size: 1.5em; cursor: pointer; margin-right: 15px; transition: color 0.2s;
        }
        #settings-btn:hover { color: var(--color-primary); }


        .user-profile { 
            display: flex; align-items: center; background-color: rgba(0, 0, 0, 0.4); 
            border-radius: 23px; padding: 3px 8px 3px 3px; cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .user-profile:hover { background-color: rgba(0, 0, 0, 0.6); }
        body.light-mode .user-profile { 
            background-color: rgba(255, 255, 255, 0.4); 
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        #profile-image { 
            width: 35px; height: 35px; border-radius: 50%; 
            background-color: #333; margin-right: 8px; object-fit: cover; 
        }
        #profile-name { font-weight: bold; font-size: 0.9em; margin-right: 10px; }


        /* Conte√∫do Principal */
        .main-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background-color: var(--secondary-background); padding: 20px 0; overflow-y: auto; flex-shrink: 0; }
        .nav-item { 
            display: flex; align-items: center; gap: 10px; padding: 10px 20px; 
            cursor: pointer; font-weight: bold; color: var(--current-subtext-color); 
            transition: color 0.2s, background-color 0.2s; 
        }
        .nav-item .material-icons { font-size: 1.2em; }
        .nav-item:hover, .nav-item.active { color: var(--current-text-color); }
        .nav-item.active { background-color: var(--tertiary-background); }

        .liked-songs-nav { 
            background-image: linear-gradient(135deg, #4f00bc, #990099); /* Fundo colorido */
            color: white; 
            margin: 10px 20px;
            padding: 10px;
            border-radius: 8px;
        }
        .liked-songs-nav:hover {
            color: white;
            opacity: 0.9;
        }
        body.light-mode .liked-songs-nav {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .library-header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-top: 20px; }
        .library-header h3 { color: var(--current-subtext-color); font-size: 0.9em; margin: 0; }
        .create-btn { background-color: transparent; border: none; color: var(--current-subtext-color); font-size: 1.5em; cursor: pointer; transition: color 0.2s; }
        .create-btn:hover { color: var(--current-text-color); }
        .playlist-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 20px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; }
        .playlist-item:hover { background-color: var(--tertiary-background); }
        .playlist-name-link { flex-grow: 1; }
        .delete-btn { background-color: transparent; border: none; color: var(--color-red); font-size: 0.9em; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .playlist-item:hover .delete-btn { opacity: 1; }
        
        .main-content { flex: 1; background-color: var(--main-background); padding: 20px; overflow-y: auto; }
        .section-content { display: none; }
        .section-content.active { display: block; }
        #back-button { 
            display: flex; align-items: center; gap: 5px; font-weight: bold; 
            margin-bottom: 30px; 
        }
        #back-button:hover { color: var(--color-primary) !important; }

        /* Estilos de Lista de Faixas */
        .track-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; margin-bottom: 5px; border-radius: 5px; 
            transition: background-color 0.2s; 
        }
        .track-list-item:hover { background-color: var(--tertiary-background); }
        .track-list-item.playing { 
            background-color: var(--tertiary-background); 
            border-left: 3px solid var(--color-primary); 
        }
        .track-list-item.playing .track-title { color: var(--color-primary); }
        .track-info { flex-grow: 1; cursor: pointer; display: flex; gap: 15px; align-items: center; }
        .track-cover-small { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        .track-details-text { display: flex; flex-direction: column; }
        .track-title { font-weight: bold; }
        .track-artist { font-size: 0.8em; color: var(--current-subtext-color); }
        .track-index { width: 30px; text-align: center; color: var(--current-subtext-color); }
        .track-actions { display: flex; gap: 10px; }
        .action-btn {
            background-color: transparent; border: none; color: var(--current-subtext-color); 
            font-size: 1.2em; cursor: pointer; transition: color 0.2s;
        }
        .action-btn:hover { color: var(--color-primary); }
        .action-btn.remove:hover { color: var(--color-red); }
        .action-btn.liked { color: var(--color-red); } /* Cora√ß√£o preenchido */
        .track-list-duration { width: 50px; text-align: right; font-size: 0.9em; color: var(--current-subtext-color); }

        /* Estilos de Gerenciamento de Conta */
        .account-form { max-width: 400px; margin-top: 20px; padding: 20px; background-color: var(--tertiary-background); border-radius: 8px; }
        .account-form input[type="text"], .account-form input[type="file"] {
            width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #555; border-radius: 4px; background-color: #333; color: var(--color-text);
        }
        body.light-mode .account-form input[type="text"] { background-color: var(--bg-light-main); color: var(--color-text-dark); border: 1px solid #ccc; }
        .account-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        .account-form button { background-color: var(--color-primary); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        #current-photo-preview { width: 80px; height: 80px; border-radius: 50%; background-color: #333; margin-bottom: 15px; object-fit: cover; }
        #google-connect-btn { background-color: #4285F4; }
        
        /* Se√ß√£o de Busca */
        #search-input {
            width: 100%; padding: 15px; font-size: 1.1em; border-radius: 30px; border: none;
            background-color: var(--secondary-background); color: var(--current-text-color);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        #search-input::placeholder { color: var(--current-subtext-color); }
        #last-search-display {
            font-size: 0.9em; color: var(--current-subtext-color); margin-bottom: 10px;
        }

        /* Player Bar e Flyout (Letras sincronizadas - Simula√ß√£o) */
        .player-bar { 
            height: 90px; background-color: var(--tertiary-background); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; border-top: 1px solid #000; 
            position: relative; 
            flex-shrink: 0;
        }
        body.light-mode .player-bar { border-top: 1px solid #ccc; }
        
        #song-details-flyout {
            position: fixed; bottom: 90px; left: 0; width: 100%; height: calc(100% - 90px);
            background-color: var(--main-background); box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.8);
            z-index: 15; display: none; padding: 20px; 
            transition: bottom 0.3s ease-out; overflow-y: auto;
            flex-direction: row;
        }
        .flyout-left, .flyout-right { flex: 1; padding: 0 30px; display: flex; flex-direction: column; align-items: center; }

        #flyout-cover {
            width: 300px; height: 300px; background-color: #333; border-radius: 8px;
            margin-bottom: 20px; background-size: cover; background-position: center;
        }
        .flyout-lyrics {
            flex: 1; width: 100%; max-width: 600px;
            overflow-y: auto; 
            padding-right: 10px; /* Espa√ßo para scrollbar */
        }
        .lyric-line {
            padding: 10px 0;
            font-size: 1.5em;
            color: var(--current-subtext-color);
            transition: color 0.3s, font-size 0.3s;
            text-align: center;
            font-weight: bold;
        }
        .lyric-line.active {
            color: var(--current-text-color);
            font-size: 1.8em;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        #flyout-title { font-size: 1.8em; font-weight: bold; margin-bottom: 5px; }
        #flyout-artist { font-size: 1.2em; color: var(--current-subtext-color); margin-bottom: 20px; }
        #flyout-close-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; font-size: 2em;
            color: var(--current-subtext-color); cursor: pointer;
            transition: color 0.2s;
        }
        #flyout-close-btn:hover { color: var(--color-red); }

        .song-info { display: flex; align-items: center; width: 25%; }
        .song-cover { 
            width: 60px; height: 60px; background-color: #333; border-radius: 4px; 
            margin-right: 15px; background-size: cover; background-position: center;
            flex-shrink: 0;
        }
        /* Efeito visual para capa de An√∫ncio */
        .song-cover.ad-cover {
            background-color: var(--color-yellow);
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 1.2em;
            display: flex; align-items: center; justify-content: center;
        }
        .song-details { cursor: pointer; } 
        .song-details #player-title { 
            font-weight: bold; color: var(--current-text-color); transition: color 0.1s;
        }
        .song-details #player-title:hover {
            color: var(--color-primary); 
        }
        /* Mensagem do An√∫ncio em destaque */
        .song-details #player-artist.ad-message { 
            color: var(--color-yellow); 
            font-weight: bold;
            font-size: 0.9em;
        }
        
        /* Controles do Player */
        .player-controls { width: 50%; display: flex; flex-direction: column; align-items: center; }
        .controls { display: flex; justify-content: center; gap: 30px; margin-bottom: 5px; }
        .control-btn { background: none; border: none; color: var(--current-text-color); font-size: 1.5em; cursor: pointer; transition: color 0.2s; }
        .control-btn:hover:not(:disabled) { color: var(--color-primary); }
        .control-btn:disabled { color: var(--current-subtext-color); opacity: 0.5; cursor: default; }
        .control-btn.active { color: var(--color-primary); } /* Para shuffle e repeat */
        .control-btn.main-play { font-size: 2em; } /* Play/Pause maior */

        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 0.75em; color: var(--current-subtext-color); }
        #seek-bar { 
            flex: 1; height: 4px; 
            /* Estilo personalizado da barra de progresso (compatibilidade pode variar) */
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        #seek-bar:not(:disabled) { cursor: pointer; }
        #seek-bar:disabled { cursor: default; opacity: 0.5; }

        /* Estilo do Thumb (bola) da barra de progresso */
        #seek-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        #seek-bar:hover::-webkit-slider-thumb {
             /* Mostra a bolinha apenas ao passar o mouse */
            background: var(--color-primary); 
        }

        /* Controles de Volume */
        .volume-control { width: 25%; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        #volume-slider { width: 100px; height: 4px; cursor: pointer; }
        #volume-icon { font-size: 1.2em; color: var(--current-text-color); }
        .player-action-btn { background: none; border: none; color: var(--current-subtext-color); font-size: 1.5em; cursor: pointer; margin-left: 10px; }
        .player-action-btn:hover { color: var(--current-text-color); }

        /* MODAIS (Estilos j√° fornecidos - Mantidos e refinados) */
        .modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--tertiary-background); margin: 10% auto; padding: 30px; border-radius: 10px; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.9); color: var(--current-text-color); }
        .close-btn { color: var(--current-subtext-color); float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: var(--current-text-color); text-decoration: none; cursor: pointer; }
        .modal-content button { background-color: var(--color-primary); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; }
        #profile-actions-modal .modal-content button { background-color: var(--secondary-background); border: 1px solid var(--current-subtext-color); }
        #profile-actions-modal .modal-content button:hover { background-color: var(--tertiary-background); }
        #google-connect-btn { background-color: #4285F4; }
        .modal-benefits li { margin-bottom: 5px; color: var(--current-subtext-color); }
        .modal-benefits li::before { content: "‚úÖ "; color: var(--color-primary); font-weight: bold; }
        
        /* Estilos de Op√ß√µes de Cor no Modal de Configura√ß√µes */
        .setting-group { margin-bottom: 20px; padding: 15px; border: 1px solid var(--current-subtext-color); border-radius: 8px; }
        .setting-group h4 { color: var(--color-primary); margin-top: 0; }
        .color-option { display: inline-block; width: 30px; height: 30px; border-radius: 50%; margin: 5px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s, transform 0.1s; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: var(--color-primary); box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); }
        #theme-mode-switch { width: 100%; height: 40px; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
        .switch-dark { background-color: var(--bg-dark); color: white; border: 1px solid white !important; }
        .switch-light { background-color: var(--bg-light-main); color: var(--color-text-dark); border: 1px solid black !important;}


        /* Design Responsivo (Mobile First - Ajustes para telas maiores) */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                order: -1; /* Move para cima no Flexbox */
                padding: 10px 0;
                border-bottom: 1px solid #333;
            }
            .main-wrapper {
                flex-direction: column;
            }
            .main-content {
                padding: 10px;
                order: 1;
            }
            .player-bar {
                padding: 0 10px;
                flex-wrap: wrap;
                height: auto;
                min-height: 90px;
            }
            .song-info, .player-controls, .volume-control {
                width: 100%;
                justify-content: center;
                margin: 5px 0;
            }
            .song-info {
                justify-content: flex-start;
            }
            .player-controls {
                order: 1; /* Coloca os controles no centro */
            }
            .volume-control {
                order: 2;
                justify-content: center;
            }
            .progress-container {
                width: 100%;
            }
            .flyout-left, .flyout-right {
                width: 100%;
                padding: 0;
                height: 50%;
                overflow-y: auto;
            }
            #song-details-flyout {
                flex-direction: column;
            }
            #flyout-cover {
                width: 200px; height: 200px;
            }
        }

    </style>
</head>
<body class="dark-mode"> 
    
    <div class="top-bar">
        <div class="top-bar-left">
            <h1 style="margin: 0; font-size: 1.5em;">M√∫sica.ly</h1>
            <button id="premium-toggle-btn" class="premium-btn" onclick="openPremiumModal()">
                Obter Premium
            </button>
        </div>

        <div style="display: flex; align-items: center;">
             <button id="settings-btn" title="Configura√ß√µes" onclick="openSettingsModal()">
                 <span class="material-icons">settings</span>
             </button>
            <div class="user-profile" onclick="openProfileActionsModal()">
                <img id="profile-image" src="imagens/profile_default.png" alt="Foto de Perfil">
                <span id="profile-name">Convidado</span>
                <span class="material-icons" style="font-size: 1.2em; margin-right: 0; margin-left: 5px;">expand_more</span>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('settings-modal').style.display='none';">&times;</span>
            <h2 style="color: var(--color-primary);">Configura√ß√µes de Tema</h2>

            <div class="setting-group">
                <h4>Modo de Cor (Dark Mode)</h4>
                <button id="theme-mode-switch" onclick="toggleThemeMode()"></button>
                <p style="font-size: 0.8em; color: var(--current-subtext-color);">Alterne entre modo escuro e modo claro.</p>
            </div>

            <div class="setting-group">
                <h4>Cor de Destaque (Acento)</h4>
                <div id="color-options-container">
                    </div>
                <p style="font-size: 0.8em; color: var(--current-subtext-color);">Escolha a cor prim√°ria do tema.</p>
            </div>

            <button onclick="saveThemeSettings()">Salvar Configura√ß√µes</button>
        </div>
    </div>

    <div id="profile-actions-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeProfileActionsModal()">&times;</span>
        <h3 style="margin-bottom: 20px;">Ol√°, <span id="modal-user-name"></span>!</h3>

        <div id="logged-out-actions">
             <button onclick="simulateGoogleLogin()" style="margin-bottom: 10px;">
                 <img src="imagens/google_icon.png" alt="G" style="width: 16px; margin-right: 5px; vertical-align: middle;">
                 Login (Simulado)
             </button>
             <button onclick="manageAccount()" style="background-color: #333; color: var(--current-text-color);">Cadastro (Simulado)</button>
        </div>

        <div id="logged-in-actions" style="display: none;">
            <button onclick="manageAccount()">Gerenciar Conta</button>
            <button onclick="logout()" style="background-color: var(--color-red); margin-top: 15px;">Sair</button>
        </div>
        
      </div>
    </div>

    <div id="premium-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closePremiumModal()">&times;</span>
        <h2 style="color: var(--color-primary);">Premium</h2>
        <p style="font-size: 1.2em; font-weight: bold;">R$ 19,90 / m√™s (Simula√ß√£o)</p>
        <p>Desfrute dos melhores benef√≠cios:</p>
        <ul class="modal-benefits">
            <li>M√∫sicas sem interrup√ß√µes de an√∫ncios.</li>
            <li>Qualidade de √°udio superior.</li>
            <li>Reprodu√ß√£o inteligente e ilimitada.</li>
            <li>Download offline (PWA - Simula√ß√£o).</li>
        </ul>
        <h3 style="margin-top: 20px;">Ativa√ß√£o (Simula√ß√£o)</h3>
        <label for="card-number" style="font-size: 0.9em;">C√≥digo do Cupom:</label>
        <input type="text" id="card-number" placeholder="Digite 'PREMIUM' para ativar" style="background-color: #444; border-radius: 5px; margin-top: 5px;"> 
        <button onclick="simulatePurchase()">Ativar Premium</button>
      </div>
    </div>

    <div id="playlist-select-modal" class="modal">
        <div class="modal-content" style="width: 250px;">
            <span class="close-btn" onclick="closePlaylistSelectModal()">&times;</span>
            <h3 style="color: var(--color-primary);">Adicionar √† Playlist</h3>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Selecione onde adicionar a m√∫sica:</p>
            <div id="playlist-options-container">
                </div>
            <button onclick="createNewPlaylist(true)">+ Criar Nova Playlist</button>
        </div>
    </div>


    <div class="main-wrapper">
        <div class="sidebar">
            <div class="nav-item active" data-section="home" onclick="showSection('home')">
                <span class="material-icons">home</span> In√≠cio
            </div>
            <div class="nav-item" data-section="explore" onclick="showSection('explore')">
                <span class="material-icons">search</span> Busca R√°pida üîç
            </div>
            <div class="nav-item liked-songs-nav" data-section="liked-songs" onclick="showSection('liked-songs')">
                <span class="material-icons">favorite</span> M√∫sicas Curtidas
            </div>
            <div class="nav-item" data-section="library" onclick="showSection('library')">
                <span class="material-icons">storage</span> Biblioteca
            </div>
            
            <div class="library-header">
                <h3>Suas Playlists</h3>
                <button class="create-btn" title="Criar nova playlist" onclick="createNewPlaylist()">
                    <span class="material-icons">add</span>
                </button>
            </div>
            <div id="playlists-list">
                </div>
        </div>

        <div class="main-content">
            <button id="back-button" style="display:none;" onclick="goBack()">
                 <span class="material-icons">arrow_back</span> Voltar
            </button>

            <div id="home-content" class="section-content active">
                <h2>Ol√°, <span id="welcome-name">Convidado</span>!</h2>
                <p>Status: <span id="user-status-text" style="font-weight: bold;">Gratuito (com an√∫ncios)</span></p>
                <div id="home-warning"></div>

                <h3>ü§ñ Recomendado para Voc√™ (Simula√ß√£o de IA)</h3>
                <div id="recommended-tracks-container">
                    </div>
                
                <h3 style="margin-top: 30px;">üîÅ Continuar de onde parou (Hist√≥rico)</h3>
                <div id="history-tracks-container">
                    </div>
                
            </div>

            <div id="account-management-content" class="section-content">
                <h2 style="color: var(--color-primary);">Gerenciar Conta</h2>
                <div class="account-form">
                    <label for="account-first-name">Nome:</label>
                    <input type="text" id="account-first-name" placeholder="Primeiro Nome">

                    <label for="account-last-name">Sobrenome:</label>
                    <input type="text" id="account-last-name" placeholder="Sobrenome">

                    <label>Foto de Perfil Atual:</label>
                    <img id="current-photo-preview" src="imagens/profile_default.png" alt="Foto de Perfil">

                    <label for="account-image-file">Trocar Foto:</label>
                    <input type="file" id="account-image-file" accept="image/*">
                    
                    <button onclick="saveAccountDetails()">Salvar Detalhes</button>
                    <button onclick="resetProfile()" style="background-color: var(--color-red); margin-left: 10px;">Resetar Conta</button>
                </div>
            </div>

            <div id="explore-content" class="section-content">
                <h2>Explorar M√∫sicas</h2>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Pesquisar por m√∫sica, artista ou √°lbum..." onkeyup="searchTracks()">
                    <div id="last-search-display"></div>
                </div>
                <div id="available-tracks-container">
                    </div>
            </div>
            
            <div id="library-content" class="section-content">
                <h2>Sua Biblioteca</h2>
                <p style="color: var(--current-subtext-color);">Gerencie suas playlists e explore por categorias.</p>
                
                <h3 style="color: var(--color-primary);">Playlists Criadas</h3>
                <div id="playlists-summary">
                    </div>
                
                <h3 style="color: var(--color-primary);">Navegar por...</h3>
                <div class="category-filters">
                    <button class="action-btn" onclick="filterLibrary('artist')">Artista</button>
                    <button class="action-btn" onclick="filterLibrary('album')">√Ålbum</button>
                    <button class="action-btn" onclick="filterLibrary('genre')">G√™nero</button>
                </div>
                <div id="filtered-library-content">
                    </div>
            </div>
            
            <div id="liked-songs-content" class="section-content">
                <h2 style="color: var(--color-primary);">‚ù§Ô∏è M√∫sicas Curtidas</h2>
                <p style="color: var(--current-subtext-color);">Suas faixas favoritas em um s√≥ lugar. Use o <span class="material-icons" style="font-size: 1em;">favorite</span> para descurtir.</p>
                <div id="liked-songs-tracks-container">
                    </div>
            </div>

            <div id="playlist-view-content" class="section-content">
                 <h2 id="current-playlist-title" style="color: var(--color-primary);"></h2>
                 <p style="color: var(--current-subtext-color);">Clique no t√≠tulo da faixa para tocar. Use o <span class="material-icons" style="font-size: 1em;">close</span> para remover.</p>
                 <button class="action-btn" onclick="playPlaylistTracks(currentPlaylistId)" style="margin-bottom: 20px; font-weight: bold; padding: 10px 20px; border: 1px solid var(--color-primary);">
                     <span class="material-icons" style="font-size: 1em;">play_arrow</span> Iniciar Playlist
                 </button>
                 <div id="playlist-tracks-container">
                     </div>
             </div>
        </div>
    </div>

    <div class="player-bar">
        
        <div id="song-details-flyout">
            <button id="flyout-close-btn" onclick="toggleSongDetailsFlyout()">
                <span class="material-icons">close</span>
            </button>
            <div class="flyout-left">
                <div id="flyout-cover"></div>
                <div id="flyout-title"></div>
                <div id="flyout-artist"></div>
            </div>
            <div class="flyout-right">
                <h3 style="color: var(--color-primary);">üé§ Letras Sincronizadas (Simula√ß√£o)</h3>
                <div id="flyout-lyrics" class="flyout-lyrics">
                    <p class="lyric-line active">Nenhuma letra dispon√≠vel.</p>
                </div>
            </div>
        </div>

        <div class="song-info">
            <div id="player-cover" class="song-cover">
                <span class="material-icons">music_note</span>
            </div> 
            <div class="song-details" onclick="toggleSongDetailsFlyout()"> 
                <div id="player-title">Nenhuma M√∫sica</div>
                <div id="player-artist"></div>
            </div>
        </div>

        <div class="player-controls">
            <div class="controls">
                <button class="control-btn" id="shuffle-btn" onclick="toggleShuffle()" title="Embaralhar">
                    <span class="material-icons">shuffle</span>
                </button>
                <button class="control-btn" id="prev-btn" onclick="prevSong()" title="Anterior">
                    <span class="material-icons">skip_previous</span>
                </button>
                <button class="control-btn main-play" id="play-pause-btn" onclick="togglePlayPause()" title="Play">
                    <span class="material-icons">play_arrow</span>
                </button>
                <button class="control-btn" id="next-btn" onclick="nextSong()" title="Pr√≥xima">
                    <span class="material-icons">skip_next</span>
                </button>
                <button class="control-btn" id="repeat-btn" onclick="toggleRepeat()" title="Repetir">
                    <span class="material-icons">repeat</span>
                </button>
            </div>
            <div class="progress-container">
                <span id="current-time">0:00</span>
                <input type="range" id="seek-bar" min="0" max="100" value="0">
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="volume-control">
            <button class="player-action-btn" id="like-btn" onclick="toggleLike(currentPlaylistTracks[currentTrackIndex]?.id)" title="Curtir M√∫sica">
                <span class="material-icons">favorite_border</span>
            </button>
            <button class="player-action-btn" id="download-btn" onclick="simulateDownload()" title="Download Offline (PWA)">
                <span class="material-icons">download</span>
            </button>
            <span id="volume-icon" class="material-icons">volume_up</span>
            <input type="range" id="volume-slider" min="0" max="100" value="100">
        </div>
        
        <audio id="audio-player"></audio>
    </div>

    <script>
        // ----------------------------------------
        // 1. DADOS E ESTADO GLOBAL (Simula√ß√£o de Back-end)
        // ----------------------------------------

        // Os dados de m√∫sicas devem ser carregados aqui
        const availableTracks = [
             // Mantenha seus dados originais
             { id: 1, title: "Pior Vers√£o", artist: "DJ BOY, Kako, MC Jo√£ozinho VT, MC Ryan SP, Oruam", src: "music/music1.mp3", coverUrl: "imagens/cover1.jpg", genre: "Funk", album: "The Box Medley", lyrics: [1, 5, "Letra de teste para Pior Vers√£o..."], duration: 225 },
             { id: 2, title: "After Do Travis", artist: "DJ Russo, MC Jo√£ozinho VT, MC Marks, MC Ryan SP, MC Vine7", src: "music/music2.mp3", coverUrl: "imagens/cover2.jpg", genre: "Funk", album: "Sem √Ålbum", lyrics: [1, 5, "Letra de teste para After Do Travis..."], duration: 250 },
             { id: 3, title: "Conex√µes de Mafia", artist: "Matue", src: "music/music3.mp3", coverUrl: "imagens/cover3.jpg", genre: "Hip-Hop", album: "The Box Medley", lyrics: [1, 5, "Letra de teste para Conex√µes de Mafia..."], duration: 190 },
             { id: 4, title: "Set Dj Boy 3.0", artist: "DJ BOY, Kako, Mc Don Juan, MC Hariel, MC Jo√£ozinho VT, MC Marks, MC Tuto, MC Vine7", src: "music/music4.mp3", coverUrl: "imagens/cover4.jpg", genre: "Funk", album: "Set Dj Boy", lyrics: [1, 5, "Letra de teste para Set Dj Boy..."], duration: 280 },
             { id: 5, title: "Cala Boca Piranha", artist: "Nadir Netto", src: "music/music5.mp3", coverUrl: "imagens/cover5.jpg", genre: "Pop", album: "Ver√£o", lyrics: [1, 5, "Letra de teste para Cala Boca Piranha..."], duration: 210 },
             { id: 6, title: "Vai Tomar No Pock Pock", artist: "MC GH Original, Mc Lele JP, MC Leozinho ZS, MC Meno K, MC Menor ZL", src: "music/music6.mp3", coverUrl: "imagens/cover6.jpg", genre: "Funk", album: "Ver√£o", lyrics: [1, 5, "Letra de teste para Vai Tomar No Pock Pock..."], duration: 205 },
             { id: 7, title: "The Box Medley 6", artist: "The Box", src: "music/music7.mp3", coverUrl: "imagens/cover7.jpg", genre: "Funk", album: "The Box Medley", lyrics: [1, 5, "Letra de teste para The Box Medley 6..."], duration: 290 },
             { id: 8, title: "Noite Infeliz", artist: "509-E", src: "music/music8.mp3", coverUrl: "imagens/cover8.jpg", genre: "Rap", album: "Grandes Hits", lyrics: [1, 5, "Letra de teste para Noite Infeliz..."], duration: 175 },
             { id: 9, title: "Saque Fantasma", artist: "Mc Kelvinho", src: "music/music9.mp3", coverUrl: "imagens/cover9.jpg", genre: "Funk", album: "Set Dj Boy", lyrics: [1, 5, "Letra de teste para Saque Fantasma..."], duration: 240 },
             { id: 10, title: "The Box Medley Funk 10", artist: "The Box", src: "music/music10.mp3", coverUrl: "imagens/cover10.jpg", genre: "Funk", album: "The Box Medley", lyrics: [1, 5, "Letra de teste para The Box Medley Funk 10..."], duration: 235 },
             { id: 11, title: "Highest In The Room", artist: "Travis Scott", src: "music/music11.mp3", coverUrl: "imagens/cover11.jpg", genre: "Hip-Hop", album: "Grandes Hits", lyrics: [1, 5, "Letra de teste para Highest In The Room..."], duration: 200 },
             { id: 12, title: "goosebumps", artist: "Travis Scott", src: "music/music12.mp3", coverUrl: "imagens/cover12.jpg", genre: "Hip-Hop", album: "Grandes Hits", lyrics: [1, 5, "Letra de teste para goosebumps..."], duration: 195 },
             { id: 13, title: "Tubar√µes", artist: "Diego & Victor Hugo", src: "music/music13.mp3", coverUrl: "imagens/cover13.jpg", genre: "Sertanejo", album: "Ver√£o", lyrics: [1, 5, "Letra de teste para Tubar√µes..."], duration: 185 },
        ];
        
        // Objeto de faixa de An√∫ncio
        const adTrack = { 
            id: 'ad', 
            title: "AN√öNCIO", 
            artist: "Obtenha Premium para remover an√∫ncios", 
            src: "music/anuncio.mp3", 
            isAd: true,
            coverUrl: "imagens/ad_cover.jpg",
            duration: 15 // Simula√ß√£o de 15 segundos
        };
        
        const defaultProfilePhoto = "imagens/profile_default.png"; 
        const defaultGooglePhoto = "imagens/google_user.png"; 
        const liked_songs_playlist_id = "liked_songs_playlist";
        
        // Cores de acento dispon√≠veis para o usu√°rio
        const accentColors = {
            'Spotify Green': '#1DB954',
            'Deep Blue': '#007bff',
            'Red Hot': '#ff4500',
            'Purple Haze': '#8a2be2',
            'Cyber Yellow': '#ffff00'
        };

        // Estado do Usu√°rio e Tema
        let currentUser = {
            firstName: "Convidado",
            lastName: "",
            name: "Convidado",
            photo: defaultProfilePhoto, 
            isPremium: false,
            isGoogleUser: false, 
            likedTracks: [], // IDs das m√∫sicas curtidas
            history: [], // IDs e timestamps das m√∫sicas ouvidas
        }; 
        
        let themeSettings = {
            mode: 'dark', // 'dark' ou 'light'
            accentColor: accentColors['Spotify Green']
        };

        // Estado do Player
        let allPlaylists = {}; 
        let currentPlaylistId = null; 
        let currentPlaylistTracks = []; // A fila atual (pode ser a biblioteca, uma playlist ou busca)
        let currentTrackIndex = 0;
        let isPlaying = false;
        let isAdPlaying = false; 
        let isShuffling = false;
        let repeatMode = 'none'; // 'none', 'one', 'all'
        let musicCounter = 0; // Conta m√∫sicas tocadas desde o √∫ltimo an√∫ncio
        let trackToAddToPlaylist = null; // Usado no modal de sele√ß√£o
        let currentVolume = 1.0;
        let sectionHistory = []; 
        let isFlyoutOpen = false;

        // Refer√™ncias DOM (mantidas)
        const audioPlayer = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const prevBtn = document.getElementById('prev-btn'); 
        const nextBtn = document.getElementById('next-btn'); 
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const likeBtn = document.getElementById('like-btn');

        const playlistSelectModal = document.getElementById('playlist-select-modal');
        const searchInput = document.getElementById('search-input'); 
        const premiumToggleBtn = document.getElementById('premium-toggle-btn');
        const userStatusText = document.getElementById('user-status-text');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const playerCover = document.getElementById('player-cover');
        const songDetailsFlyout = document.getElementById('song-details-flyout');
        const seekBar = document.getElementById('seek-bar');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeIcon = document.getElementById('volume-icon');
        const backButton = document.getElementById('back-button');
        const profileActionsModal = document.getElementById('profile-actions-modal');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const flyoutLyricsEl = document.getElementById('flyout-lyrics');
        
        const settingsModal = document.getElementById('settings-modal');
        const themeModeSwitch = document.getElementById('theme-mode-switch');


        // ----------------------------------------
        // 2. FUN√á√ïES DE PERSIST√äNCIA (localStorage)
        // ----------------------------------------

        function saveState() {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('allPlaylists', JSON.stringify(allPlaylists));
            localStorage.setItem('themeSettings', JSON.stringify(themeSettings));
            localStorage.setItem('sectionHistory', JSON.stringify(sectionHistory));
            localStorage.setItem('playerState', JSON.stringify({
                currentVolume: audioPlayer.volume,
                isShuffling: isShuffling,
                repeatMode: repeatMode
            }));
        }

        function loadState() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const loadedUser = JSON.parse(savedUser);
                currentUser = { ...currentUser, ...loadedUser };
                // Garante que likedTracks existe
                if (!currentUser.likedTracks) currentUser.likedTracks = [];
                if (!currentUser.history) currentUser.history = [];
            }
            
            const savedPlaylists = localStorage.getItem('allPlaylists');
            if (savedPlaylists) {
                allPlaylists = JSON.parse(savedPlaylists);
                // Se a playlist de curtidas n√£o existir, cria
                if (!allPlaylists[liked_songs_playlist_id]) {
                     allPlaylists[liked_songs_playlist_id] = { 
                        id: liked_songs_playlist_id, 
                        name: "M√∫sicas Curtidas", 
                        isPredefined: true,
                        tracks: currentUser.likedTracks.map(id => getTrackById(id)).filter(Boolean)
                    };
                }
            } else {
                 // Inicializa a playlist de curtidas se n√£o houver playlists salvas
                 allPlaylists[liked_songs_playlist_id] = { 
                    id: liked_songs_playlist_id, 
                    name: "M√∫sicas Curtidas", 
                    isPredefined: true,
                    tracks: []
                };
            }
            
            const savedTheme = localStorage.getItem('themeSettings');
            if (savedTheme) {
                themeSettings = JSON.parse(savedTheme);
            }
            applyTheme();

            const savedHistory = localStorage.getItem('sectionHistory');
            if (savedHistory) {
                sectionHistory = JSON.parse(savedHistory);
            }
            
            const savedPlayerState = localStorage.getItem('playerState');
            if (savedPlayerState) {
                const state = JSON.parse(savedPlayerState);
                audioPlayer.volume = state.currentVolume;
                volumeSlider.value = state.currentVolume * 100;
                currentVolume = state.currentVolume;
                isShuffling = state.isShuffling;
                repeatMode = state.repeatMode;
                
                // Atualiza a UI do player (shuffle/repeat)
                shuffleBtn.classList.toggle('active', isShuffling);
                updateRepeatButtonUI();
                updateVolumeIcon();
            }
        }
        
        // ----------------------------------------
        // 3. FUN√á√ïES UTILIT√ÅRIAS E DE RENDERIZA√á√ÉO
        // ----------------------------------------
        
        /**
         * Encontra uma faixa pelo ID.
         * @param {number|string} id - O ID da faixa.
         * @returns {object|undefined} O objeto da faixa.
         */
        function getTrackById(id) {
             // IDs das faixas s√£o n√∫meros. O ID do an√∫ncio √© 'ad'.
             if (id === 'ad') return adTrack;
             return availableTracks.find(track => track.id === id);
        }

        /**
         * Converte segundos em formato M:SS.
         * @param {number} seconds - Dura√ß√£o em segundos.
         * @returns {string} Tempo formatado.
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        /**
         * Renderiza a lista de m√∫sicas em um cont√™iner.
         * @param {Array<object>} tracks - Array de objetos de m√∫sica.
         * @param {HTMLElement} container - O elemento DOM onde a lista ser√° inserida.
         * @param {boolean} allowRemove - Se deve mostrar o bot√£o de remover.
         * @param {string|null} currentListId - O ID da lista que est√° sendo renderizada.
         */
        function renderTrackList(tracks, container, allowRemove = false, currentListId = null) {
            container.innerHTML = '';
            
            if (tracks.length === 0) {
                 container.innerHTML = `<p style="color: var(--current-subtext-color);">Nenhuma m√∫sica encontrada.</p>`;
                 return;
            }

            tracks.forEach((track, index) => {
                const trackElement = document.createElement('div');
                trackElement.className = 'track-list-item';
                trackElement.classList.toggle('playing', currentPlaylistTracks[currentTrackIndex]?.id === track.id);
                trackElement.dataset.trackId = track.id;
                
                const isLiked = currentUser.likedTracks.includes(track.id);
                
                // Estrutura do item da lista
                trackElement.innerHTML = `
                    <span class="track-index">${index + 1}</span>
                    <div class="track-info" onclick="playTrackFromList('${track.id}', '${currentListId}')">
                         <img src="${track.coverUrl}" alt="Capa" class="track-cover-small">
                        <div class="track-details-text">
                            <span class="track-title">${track.title}</span>
                            <span class="track-artist">${track.artist}</span>
                        </div>
                    </div>
                    <span class="track-list-duration">${formatTime(track.duration || 0)}</span>
                    <div class="track-actions">
                        <button class="action-btn like-toggle-btn ${isLiked ? 'liked' : ''}" 
                                onclick="event.stopPropagation(); toggleLike('${track.id}', this)"
                                title="${isLiked ? 'Descurtir' : 'Curtir'}">
                            <span class="material-icons">${isLiked ? 'favorite' : 'favorite_border'}</span>
                        </button>
                        <button class="action-btn" 
                                onclick="event.stopPropagation(); openPlaylistSelectModal('${track.id}')"
                                title="Adicionar √† Playlist">
                            <span class="material-icons">playlist_add</span>
                        </button>
                        ${allowRemove && currentListId !== liked_songs_playlist_id ? `
                            <button class="action-btn remove" 
                                    onclick="event.stopPropagation(); removeTrackFromPlaylist('${currentListId}', '${track.id}', this)"
                                    title="Remover">
                                <span class="material-icons">close</span>
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(trackElement);
            });
        }
        
        // ----------------------------------------
        // 4. PLAYER DE M√öSICA (Fun√ß√µes Core)
        // ----------------------------------------

        /**
         * Define a fila de reprodu√ß√£o e carrega uma faixa.
         * @param {string|null} listId - O ID da lista de reprodu√ß√£o (playlist, 'explore', 'liked_songs').
         */
        function setCurrentPlaylist(listId) {
            currentPlaylistId = listId;
            sectionHistory.pop(); // Remove a se√ß√£o de visualiza√ß√£o de playlist anterior
            
            if (listId === liked_songs_playlist_id) {
                currentPlaylistTracks = currentUser.likedTracks.map(id => getTrackById(id)).filter(Boolean);
            } else if (listId === 'explore') {
                currentPlaylistTracks = [...availableTracks];
            } else if (allPlaylists[listId]) {
                 currentPlaylistTracks = allPlaylists[listId].tracks;
            } else {
                // Fila vazia se a lista n√£o for encontrada
                currentPlaylistTracks = [];
            }
        }
        
        /**
         * Carrega uma faixa no player.
         * @param {object} track - Objeto da faixa a ser carregada.
         */
        function loadTrack(track) {
            if (!track) return;
            
            isAdPlaying = track.isAd || false;
            
            audioPlayer.src = track.src;
            playerTitle.textContent = track.title;
            playerArtist.textContent = track.artist;
            
            // L√≥gica de Capa e Mensagens Espec√≠ficas
            playerCover.style.backgroundImage = isAdPlaying ? 'none' : `url(${track.coverUrl})`;
            playerCover.classList.toggle('ad-cover', isAdPlaying);
            playerArtist.classList.toggle('ad-message', isAdPlaying);

            if (isAdPlaying) {
                 playerCover.innerHTML = 'AD';
                 playerTitle.style.color = 'var(--current-text-color)';
            } else {
                 playerCover.innerHTML = '';
                 // Atualiza o estado de like no player
                 updateLikeButtonUI(track.id);
            }
            
            // Garante que o progresso est√° zerado
            seekBar.value = 0;
            currentTimeEl.textContent = '0:00';
            
            // A dura√ß√£o real s√≥ √© carregada ap√≥s o 'loadedmetadata'
            audioPlayer.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(audioPlayer.duration);
                seekBar.max = audioPlayer.duration;
            }, { once: true });
            
            // Atualiza a visualiza√ß√£o da fila de reprodu√ß√£o
            document.querySelectorAll('.track-list-item').forEach(el => {
                 el.classList.remove('playing');
                 if (el.dataset.trackId == track.id) {
                      el.classList.add('playing');
                      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
            });
            
            // Atualiza o Flyout se estiver aberto
            if (isFlyoutOpen) {
                 renderFlyoutDetails(track);
            }
            
            // Se n√£o estiver tocando, apenas carrega
            if (!isPlaying) audioPlayer.load();
        }

        /**
         * Inicia a reprodu√ß√£o de uma m√∫sica clicada em uma lista.
         * @param {number|string} trackId - ID da faixa.
         * @param {string} listId - ID da lista onde a faixa foi clicada.
         */
        function playTrackFromList(trackId, listId) {
            setCurrentPlaylist(listId);
            
            const newIndex = currentPlaylistTracks.findIndex(t => t.id == trackId);
            if (newIndex !== -1) {
                currentTrackIndex = newIndex;
                loadTrack(currentPlaylistTracks[currentTrackIndex]);
                playTrack();
            }
        }
        
        /**
         * Toca todas as faixas de uma playlist (inicia a fila).
         * @param {string} listId - ID da playlist.
         */
        function playPlaylistTracks(listId) {
             setCurrentPlaylist(listId);
             if (currentPlaylistTracks.length > 0) {
                 currentTrackIndex = 0;
                 loadTrack(currentPlaylistTracks[currentTrackIndex]);
                 playTrack();
             }
        }

        function playTrack() {
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => {
                     console.error("Erro ao tentar tocar: A√ß√£o do usu√°rio necess√°ria.", e);
                     alert("O navegador exige intera√ß√£o do usu√°rio para iniciar o √°udio. Tente clicar no play novamente.");
                });
                isPlaying = true;
                playPauseBtn.querySelector('.material-icons').textContent = 'pause';
            }
        }

        function pauseTrack() {
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                isPlaying = false;
                playPauseBtn.querySelector('.material-icons').textContent = 'play_arrow';
            }
        }

        function togglePlayPause() {
            if (isAdPlaying) {
                 // N√£o permite pausar an√∫ncio (comportamento de player gratuito)
                 return;
            }
            if (isPlaying) {
                pauseTrack();
            } else {
                // Se n√£o h√° m√∫sica na fila, carrega a primeira da 'explore'
                if (currentPlaylistTracks.length === 0) {
                     setCurrentPlaylist('explore');
                     currentTrackIndex = 0;
                }
                loadTrack(currentPlaylistTracks[currentTrackIndex]);
                playTrack();
            }
        }
        
        /**
         * L√≥gica para tocar a pr√≥xima faixa (inclui an√∫ncios).
         */
        function nextSong() {
            // Se for an√∫ncio, n√£o permite pular se for Conta Gratuita
            if (isAdPlaying && !currentUser.isPremium) {
                 alert("A√ß√£o de pular n√£o permitida na Conta Gratuita durante an√∫ncios.");
                 return;
            }
            
            if (currentPlaylistTracks.length === 0) return;
            
            // 1. L√≥gica de An√∫ncio
            if (!currentUser.isPremium && musicCounter >= 3 && !isAdPlaying) {
                 // Toca o an√∫ncio ap√≥s 3 m√∫sicas, se n√£o for premium
                 musicCounter = 0;
                 isAdPlaying = true;
                 loadTrack(adTrack);
                 playTrack();
                 return;
            }
            
            // 2. L√≥gica de Repeti√ß√£o (Repetir Um)
            if (repeatMode === 'one' && !isAdPlaying) {
                 // Reinicia a m√∫sica atual
                 audioPlayer.currentTime = 0;
                 playTrack();
                 return;
            }
            
            // 3. L√≥gica Principal (Avan√ßar na Fila)
            let nextIndex = currentTrackIndex + 1;
            
            if (nextIndex >= currentPlaylistTracks.length) {
                if (repeatMode === 'all') {
                    nextIndex = 0; // Volta para o in√≠cio
                } else {
                    // Fim da lista sem repeti√ß√£o total
                    currentTrackIndex = 0;
                    loadTrack(currentPlaylistTracks[currentTrackIndex]);
                    pauseTrack();
                    return; 
                }
            }

            // Atualiza o contador de m√∫sica se n√£o for an√∫ncio
            if (!isAdPlaying) {
                 musicCounter++;
                 // Salva o hist√≥rico (simulado)
                 currentUser.history.unshift(currentPlaylistTracks[currentTrackIndex].id);
                 if (currentUser.history.length > 50) currentUser.history.pop();
            }

            // Move para a pr√≥xima faixa
            currentTrackIndex = nextIndex;
            loadTrack(currentPlaylistTracks[currentTrackIndex]);
            playTrack();
            isAdPlaying = false; // Garante que o flag de an√∫ncio est√° desligado para a pr√≥xima m√∫sica
            saveState();
        }

        /**
         * Toca a faixa anterior.
         */
        function prevSong() {
            // Se a m√∫sica est√° tocando h√° mais de 3 segundos, reinicia (padr√£o de players)
            if (audioPlayer.currentTime > 3 || currentTrackIndex === 0) {
                audioPlayer.currentTime = 0;
                playTrack(); // Garante que a reprodu√ß√£o continua
                return;
            }
            
            // Se n√£o, volta para a anterior
            let prevIndex = currentTrackIndex - 1;
            
            if (prevIndex < 0) {
                // Vai para a √∫ltima da fila
                prevIndex = currentPlaylistTracks.length - 1;
            }
            
            currentTrackIndex = prevIndex;
            loadTrack(currentPlaylistTracks[currentTrackIndex]);
            playTrack();
        }

        /**
         * L√≥gica de Embaralhar (Shuffle)
         */
        function toggleShuffle() {
            isShuffling = !isShuffling;
            shuffleBtn.classList.toggle('active', isShuffling);
            
            // Nota: Em um player real, o shuffle reordenaria a fila `currentPlaylistTracks`.
            // Para simplificar, estamos apenas controlando o estado de shuffle visualmente.
            // A l√≥gica `nextSong` precisaria ser mais complexa para selecionar faixas aleat√≥rias.
            // No nosso caso simplificado, o shuffle apenas muda o estado e deve ser tratado na l√≥gica do next.
            alert("Embaralhar: " + (isShuffling ? "Ativo" : "Desativado") + ". (Requer l√≥gica mais avan√ßada de fila no backend/JS)");
            saveState();
        }

        /**
         * L√≥gica de Repeti√ß√£o
         */
        function toggleRepeat() {
            const modes = ['none', 'all', 'one'];
            let currentIndex = modes.indexOf(repeatMode);
            
            // Avan√ßa para o pr√≥ximo modo
            currentIndex = (currentIndex + 1) % modes.length;
            repeatMode = modes[currentIndex];

            updateRepeatButtonUI();
            saveState();
        }
        
        function updateRepeatButtonUI() {
             const icon = repeatBtn.querySelector('.material-icons');
             repeatBtn.classList.remove('active'); 
             
             switch (repeatMode) {
                 case 'none':
                     icon.textContent = 'repeat';
                     break;
                 case 'all':
                     icon.textContent = 'repeat';
                     repeatBtn.classList.add('active'); 
                     break;
                 case 'one':
                     icon.textContent = 'repeat_one';
                     repeatBtn.classList.add('active'); 
                     break;
             }
        }

        // Evento de Fim de M√∫sica
        audioPlayer.addEventListener('ended', () => {
             // A l√≥gica de `nextSong` j√° trata o repeat='one' e o avan√ßo.
             nextSong();
        });
        
        // Atualiza√ß√£o da Barra de Progresso
        audioPlayer.addEventListener('timeupdate', () => {
             if (audioPlayer.duration) {
                 seekBar.value = audioPlayer.currentTime;
                 currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                 
                 // Simula√ß√£o de Letras Sincronizadas
                 if (isFlyoutOpen) {
                      simulateLyricSync(audioPlayer.currentTime);
                 }
             }
        });

        // Intera√ß√£o do Usu√°rio com a Barra de Progresso
        seekBar.addEventListener('input', () => {
             audioPlayer.currentTime = seekBar.value;
        });

        // Controle de Volume
        volumeSlider.addEventListener('input', () => {
             audioPlayer.volume = volumeSlider.value / 100;
             currentVolume = audioPlayer.volume;
             updateVolumeIcon();
             saveState();
        });
        
        function updateVolumeIcon() {
             if (currentVolume >= 0.7) {
                 volumeIcon.textContent = 'volume_up';
             } else if (currentVolume > 0) {
                 volumeIcon.textContent = 'volume_down';
             } else {
                 volumeIcon.textContent = 'volume_off';
             }
        }

        // ----------------------------------------
        // 5. M√öSICAS CURTIDAS (FAVORITOS)
        // ----------------------------------------
        
        /**
         * Altera o status de "curtido" de uma m√∫sica.
         * @param {number} trackId - ID da faixa.
         * @param {HTMLElement|null} element - O bot√£o de cora√ß√£o que foi clicado.
         */
        function toggleLike(trackId, element = null) {
            const id = parseInt(trackId);
            if (isNaN(id)) return;

            const index = currentUser.likedTracks.indexOf(id);
            
            if (index === -1) {
                currentUser.likedTracks.push(id); // Curte
            } else {
                currentUser.likedTracks.splice(index, 1); // Descurte
            }
            
            // 1. Atualiza a UI do bot√£o de like clicado
            if (element) {
                 element.classList.toggle('liked', index === -1);
                 element.querySelector('.material-icons').textContent = index === -1 ? 'favorite' : 'favorite_border';
            }
            
            // 2. Atualiza a UI do bot√£o de like no player (se for a m√∫sica atual)
            updateLikeButtonUI(id);
            
            // 3. Atualiza a playlist de M√∫sicas Curtidas
            updateLikedSongsPlaylist();
            
            // 4. Salva o estado
            saveState();
            
            // Se estiver na se√ß√£o de curtidas, renderiza novamente
            if (document.getElementById('liked-songs-content').classList.contains('active')) {
                 renderSection('liked-songs');
            }
        }
        
        /**
         * Atualiza o estado visual do bot√£o de curtir no player.
         * @param {number} trackId - ID da faixa atual.
         */
        function updateLikeButtonUI(trackId) {
             const isLiked = currentUser.likedTracks.includes(trackId);
             likeBtn.classList.toggle('active', isLiked);
             likeBtn.querySelector('.material-icons').textContent = isLiked ? 'favorite' : 'favorite_border';
        }

        /**
         * Sincroniza a lista de curtidas com a playlist interna.
         */
        function updateLikedSongsPlaylist() {
            const likedTracksList = currentUser.likedTracks.map(id => getTrackById(id)).filter(Boolean);
             allPlaylists[liked_songs_playlist_id].tracks = likedTracksList;
             renderPlaylistsSidebar();
        }

        // ----------------------------------------
        // 6. PLAYLISTS (Cria√ß√£o, Gerenciamento)
        // ----------------------------------------
        
        /**
         * Renderiza a lista de playlists na sidebar.
         */
        function renderPlaylistsSidebar() {
             const listContainer = document.getElementById('playlists-list');
             listContainer.innerHTML = '';
             
             // Filtra playlists criadas pelo usu√°rio
             const userPlaylists = Object.values(allPlaylists).filter(p => !p.isPredefined);
             
             userPlaylists.forEach(playlist => {
                 const item = document.createElement('div');
                 item.className = 'playlist-item';
                 item.dataset.playlistId = playlist.id;
                 item.innerHTML = `
                     <span class="playlist-name-link" onclick="viewPlaylist('${playlist.id}')">${playlist.name}</span>
                     <button class="delete-btn" onclick="event.stopPropagation(); deletePlaylist('${playlist.id}')">
                         <span class="material-icons">delete</span>
                     </button>
                 `;
                 listContainer.appendChild(item);
             });
             
             // Atualiza o resumo da biblioteca se estiver ativo
             if (document.getElementById('library-content').classList.contains('active')) {
                  renderLibraryContent();
             }
        }
        
        /**
         * Cria uma nova playlist.
         * @param {boolean} addTrackToIt - Se deve adicionar a faixa atual logo ap√≥s a cria√ß√£o.
         */
        function createNewPlaylist(addTrackToIt = false) {
             const name = prompt("Digite o nome da nova Playlist:");
             if (name && name.trim()) {
                 const newId = `p${Date.now()}`;
                 allPlaylists[newId] = {
                     id: newId,
                     name: name.trim(),
                     isPredefined: false,
                     tracks: []
                 };
                 saveState();
                 renderPlaylistsSidebar();
                 
                 alert(`Playlist "${name.trim()}" criada com sucesso!`);
                 
                 if (addTrackToIt && trackToAddToPlaylist) {
                      addTrackToPlaylist(newId, trackToAddToPlaylist.id);
                      closePlaylistSelectModal();
                 }
             }
        }
        
        /**
         * Remove uma playlist.
         * @param {string} playlistId - ID da playlist.
         */
        function deletePlaylist(playlistId) {
             if (confirm(`Tem certeza que deseja deletar a playlist ${allPlaylists[playlistId].name}?`)) {
                 delete allPlaylists[playlistId];
                 saveState();
                 renderPlaylistsSidebar();
                 // Se estava visualizando, volta para a home
                 if (currentPlaylistId === playlistId) {
                      showSection('home');
                 }
                 alert("Playlist deletada com sucesso!");
             }
        }
        
        /**
         * Adiciona uma faixa a uma playlist.
         * @param {string} playlistId - ID da playlist.
         * @param {number} trackId - ID da faixa a ser adicionada.
         */
        function addTrackToPlaylist(playlistId, trackId) {
             const playlist = allPlaylists[playlistId];
             const track = getTrackById(trackId);
             
             if (playlist && track) {
                 if (!playlist.tracks.some(t => t.id === trackId)) {
                     playlist.tracks.push(track);
                     saveState();
                     alert(`"${track.title}" adicionada a "${playlist.name}".`);
                     // Se estiver na visualiza√ß√£o da playlist, renderiza novamente
                     if (currentPlaylistId === playlistId) {
                          viewPlaylist(playlistId);
                     }
                 } else {
                     alert(`"${track.title}" j√° est√° na playlist "${playlist.name}".`);
                 }
             }
        }
        
        /**
         * Remove uma faixa de uma playlist.
         * @param {string} playlistId - ID da playlist.
         * @param {number} trackId - ID da faixa a ser removida.
         * @param {HTMLElement|null} element - O elemento da lista para remover (otimiza√ß√£o de UI).
         */
        function removeTrackFromPlaylist(playlistId, trackId, element = null) {
            const playlist = allPlaylists[playlistId];
            if (playlist) {
                 const index = playlist.tracks.findIndex(t => t.id == trackId);
                 if (index !== -1) {
                     playlist.tracks.splice(index, 1);
                     saveState();
                     
                     if (element) {
                         element.parentElement.parentElement.remove(); // Remove o item da lista
                     }
                     
                     alert(`M√∫sica removida da playlist "${playlist.name}".`);
                 }
            }
        }

        // ----------------------------------------
        // 7. GERENCIAMENTO DE CONTA E MODAIS
        // ----------------------------------------
        
        function updateProfileUI() {
             const nameDisplay = currentUser.name || (currentUser.firstName || "Convidado");
             
             document.getElementById('profile-name').textContent = nameDisplay;
             document.getElementById('welcome-name').textContent = nameDisplay;
             document.getElementById('profile-image').src = currentUser.photo;
             document.getElementById('current-photo-preview').src = currentUser.photo;
             
             // Atualiza campos de gerenciamento
             document.getElementById('account-first-name').value = currentUser.firstName === "Convidado" ? "" : currentUser.firstName;
             document.getElementById('account-last-name').value = currentUser.lastName;
             
             // Atualiza Status Premium
             userStatusText.textContent = currentUser.isPremium ? "Premium ‚úÖ (Sem an√∫ncios)" : "Gratuito (com an√∫ncios)";
             premiumToggleBtn.textContent = currentUser.isPremium ? "Premium Ativo" : "Obter Premium";
             premiumToggleBtn.classList.toggle('active', currentUser.isPremium);

             // Atualiza o modal de a√ß√µes
             document.getElementById('modal-user-name').textContent = nameDisplay;
             document.getElementById('logged-in-actions').style.display = (currentUser.name === "Convidado") ? 'none' : 'block';
             document.getElementById('logged-out-actions').style.display = (currentUser.name === "Convidado") ? 'block' : 'none';

             saveState();
        }

        function simulateGoogleLogin() {
             currentUser.firstName = "Usu√°rio";
             currentUser.lastName = "Google";
             currentUser.name = "Usu√°rio Google";
             currentUser.photo = defaultGooglePhoto;
             currentUser.isGoogleUser = true;
             updateProfileUI();
             closeProfileActionsModal();
             alert("Login (Simulado) realizado com sucesso!");
        }

        function logout() {
             currentUser = {
                 firstName: "Convidado",
                 lastName: "",
                 name: "Convidado",
                 photo: defaultProfilePhoto, 
                 isPremium: false,
                 isGoogleUser: false, 
                 likedTracks: [],
                 history: []
             };
             // Limpa playlists do usu√°rio, mas mant√©m a de curtidas vazia
             allPlaylists = {
                 [liked_songs_playlist_id]: { 
                    id: liked_songs_playlist_id, 
                    name: "M√∫sicas Curtidas", 
                    isPredefined: true,
                    tracks: []
                }
             };
             currentPlaylistTracks = []; // Limpa a fila
             pauseTrack(); // Pausa a m√∫sica
             
             renderPlaylistsSidebar();
             updateProfileUI();
             closeProfileActionsModal();
             alert("Logout realizado.");
             showSection('home');
        }

        function manageAccount() {
             closeProfileActionsModal();
             showSection('account-management');
        }
        
        function saveAccountDetails() {
             const firstName = document.getElementById('account-first-name').value.trim();
             const lastName = document.getElementById('account-last-name').value.trim();
             
             if (firstName) {
                 currentUser.firstName = firstName;
                 currentUser.lastName = lastName;
                 currentUser.name = firstName; // Usa apenas o primeiro nome para o display
                 if (lastName) currentUser.name += ` ${lastName}`;
             } else {
                 alert("O nome n√£o pode ser vazio.");
                 return;
             }
             
             // Simula√ß√£o de upload de foto
             const fileInput = document.getElementById('account-image-file');
             if (fileInput.files.length > 0) {
                 // Converte o arquivo para uma URL de dados (simula√ß√£o)
                 const reader = new FileReader();
                 reader.onload = function(e) {
                      currentUser.photo = e.target.result;
                      updateProfileUI();
                      alert("Detalhes e foto de perfil salvos (localmente)!");
                 };
                 reader.readAsDataURL(fileInput.files[0]);
             } else {
                 updateProfileUI();
                 alert("Detalhes salvos (localmente)!");
             }
             
        }
        
        function resetProfile() {
            if (confirm("ATEN√á√ÉO: Isso resetar√° sua conta, playlists e curtidas. Deseja continuar?")) {
                 logout(); // O logout j√° faz um reset completo
            }
        }
        
        function openProfileActionsModal() {
             document.getElementById('modal-user-name').textContent = currentUser.name;
             profileActionsModal.style.display = 'block';
        }
        function closeProfileActionsModal() {
             profileActionsModal.style.display = 'none';
        }
        
        function openPremiumModal() {
             document.getElementById('premium-modal').style.display = 'block';
        }
        function closePremiumModal() {
             document.getElementById('premium-modal').style.display = 'none';
        }

        function simulatePurchase() {
             const code = document.getElementById('card-number').value.trim().toUpperCase();
             if (code === 'PREMIUM') {
                 currentUser.isPremium = true;
                 updateProfileUI();
                 closePremiumModal();
                 alert("Parab√©ns! Sua conta Premium (Simulada) est√° ativa. Voc√™ n√£o ver√° mais an√∫ncios!");
             } else {
                 alert("C√≥digo inv√°lido. Digite 'PREMIUM' para ativar a simula√ß√£o.");
             }
        }
        
        function openPlaylistSelectModal(trackId) {
             const track = getTrackById(trackId);
             if (!track) return;
             
             trackToAddToPlaylist = track;
             const container = document.getElementById('playlist-options-container');
             container.innerHTML = '';
             
             // Renderiza a lista de playlists do usu√°rio para sele√ß√£o
             const userPlaylists = Object.values(allPlaylists).filter(p => !p.isPredefined);
             
             userPlaylists.forEach(playlist => {
                 const isTrackInPlaylist = playlist.tracks.some(t => t.id == trackId);
                 const button = document.createElement('button');
                 button.textContent = playlist.name;
                 button.style.marginTop = '5px';
                 button.style.backgroundColor = isTrackInPlaylist ? 'var(--secondary-background)' : 'var(--color-primary)';
                 button.style.color = isTrackInPlaylist ? 'var(--current-subtext-color)' : 'white';
                 button.disabled = isTrackInPlaylist;
                 
                 if (!isTrackInPlaylist) {
                      button.onclick = () => addTrackToPlaylist(playlist.id, trackId);
                 }
                 container.appendChild(button);
             });
             
             playlistSelectModal.style.display = 'block';
        }
        
        function closePlaylistSelectModal() {
             playlistSelectModal.style.display = 'none';
             trackToAddToPlaylist = null;
        }


        // ----------------------------------------
        // 8. BUSCA E FILTRO
        // ----------------------------------------
        
        /**
         * Executa a busca na biblioteca de faixas.
         */
        function searchTracks() {
             const query = searchInput.value.toLowerCase().trim();
             const container = document.getElementById('available-tracks-container');
             const lastSearchEl = document.getElementById('last-search-display');
             
             if (query.length < 2) {
                 lastSearchEl.textContent = "Digite pelo menos 2 caracteres para buscar.";
                 container.innerHTML = `<p style="color: var(--current-subtext-color);">Digite sua pesquisa acima.</p>`;
                 return;
             }
             
             const results = availableTracks.filter(track => 
                 track.title.toLowerCase().includes(query) || 
                 track.artist.toLowerCase().includes(query) ||
                 track.album.toLowerCase().includes(query) // Inclui √°lbum na busca
             );
             
             lastSearchEl.textContent = `Resultados para: "${query}" (${results.length} faixas)`;
             
             // Define a fila de reprodu√ß√£o para os resultados da busca
             currentPlaylistTracks = results;
             currentPlaylistId = 'search';

             // Renderiza a lista de resultados (sem bot√£o de remover)
             renderTrackList(results, container, false, 'search');
        }

        /**
         * Simula√ß√£o de filtro de biblioteca.
         * @param {string} filterType - 'artist', 'album', ou 'genre'.
         */
        function filterLibrary(filterType) {
             const container = document.getElementById('filtered-library-content');
             container.innerHTML = `<h3>Listando por ${filterType.toUpperCase()}...</h3>`;
             
             const groups = availableTracks.reduce((acc, track) => {
                 const key = track[filterType] || 'Desconhecido';
                 if (!acc[key]) {
                     acc[key] = [];
                 }
                 acc[key].push(track);
                 return acc;
             }, {});
             
             // Cria bot√µes ou listas para cada grupo
             const groupKeys = Object.keys(groups).sort();
             groupKeys.forEach(key => {
                 const groupEl = document.createElement('div');
                 groupEl.className = 'library-group';
                 groupEl.innerHTML = `
                     <h4 style="color: var(--color-subtext); margin-top: 20px;">${key} (${groups[key].length} faixas)</h4>
                     <button class="action-btn" onclick="viewGroupTracks('${filterType}', '${key}')" 
                             style="width: auto; padding: 5px 10px; margin-bottom: 10px;">
                         Ver Todas
                     </button>
                 `;
                 container.appendChild(groupEl);
             });
        }
        
        /**
         * Simula a visualiza√ß√£o das faixas de um grupo (artista, √°lbum, etc.).
         * @param {string} filterType - O tipo de filtro (artist, album, genre).
         * @param {string} key - O valor do filtro (o nome do artista/√°lbum/g√™nero).
         */
        function viewGroupTracks(filterType, key) {
             const tracks = availableTracks.filter(track => track[filterType] === key);
             
             // Muda para a visualiza√ß√£o din√¢mica de playlist
             document.getElementById('current-playlist-title').textContent = `${key} (${filterType.charAt(0).toUpperCase() + filterType.slice(1)})`;
             
             // Define a fila de reprodu√ß√£o para este grupo
             currentPlaylistTracks = tracks;
             currentPlaylistId = `filter_${filterType}_${key}`;
             
             renderTrackList(tracks, document.getElementById('playlist-tracks-container'), false, currentPlaylistId);
             showSection('playlist-view');
        }


        // ----------------------------------------
        // 9. NAVEGA√á√ÉO, HIST√ìRICO E UI
        // ----------------------------------------
        
        /**
         * Atualiza o hist√≥rico de navega√ß√£o.
         * @param {string} sectionId - O ID da se√ß√£o.
         */
        function updateHistory(sectionId) {
             const currentSection = sectionHistory.length > 0 ? sectionHistory[sectionHistory.length - 1] : null;
             
             if (currentSection !== sectionId && sectionId !== 'flyout') {
                 sectionHistory.push(sectionId);
             }
             if (sectionHistory.length > 10) {
                 sectionHistory.shift();
             }
             backButton.style.display = sectionHistory.length > 1 ? 'flex' : 'none';
        }
        
        /**
         * Mostra uma se√ß√£o principal do site.
         * @param {string} sectionId - O ID da se√ß√£o a ser exibida ('home', 'explore', etc.).
         */
        function showSection(sectionId, playlistId = null) { 
            const currentActiveSection = document.querySelector('.section-content.active')?.id.replace('-content', '');
            
            if (currentActiveSection && currentActiveSection !== sectionId && !isFlyoutOpen) {
                 updateHistory(currentActiveSection);
            }
            
            // Fecha o flyout se estiver aberto
            if (isFlyoutOpen) {
                 toggleSongDetailsFlyout();
            }

            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const targetSectionElement = document.getElementById(`${sectionId}-content`);
            const targetNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);

            if (targetSectionElement) {
                targetSectionElement.classList.add('active');
                if (targetNavItem) targetNavItem.classList.add('active');

                // A√ß√µes espec√≠ficas por se√ß√£o
                switch(sectionId) {
                    case 'explore':
                        currentPlaylistTracks = [...availableTracks];
                        currentPlaylistId = 'explore';
                        renderTrackList(availableTracks, document.getElementById('available-tracks-container'), false, 'explore');
                        break;
                    case 'liked-songs':
                        renderSection('liked-songs');
                        break;
                    case 'library':
                        renderLibraryContent();
                        break;
                    case 'playlist-view':
                        // Requer playlistId ser passado
                        if (playlistId) {
                             viewPlaylist(playlistId);
                             targetNavItem.classList.add('active'); // O item da playlist na sidebar
                        }
                        break;
                    case 'home':
                        renderHomeContent();
                        break;
                }
            }
            
            backButton.style.display = sectionHistory.length > 0 ? 'flex' : 'none';
        }
        
        /**
         * Volta para a se√ß√£o anterior no hist√≥rico.
         */
        function goBack() {
             if (sectionHistory.length > 0) {
                 const prevSection = sectionHistory.pop();
                 showSection(prevSection);
                 backButton.style.display = sectionHistory.length > 0 ? 'flex' : 'none';
             }
        }
        
        /**
         * Renderiza o conte√∫do da Home (Recomenda√ß√µes e Hist√≥rico).
         */
        function renderHomeContent() {
             const recContainer = document.getElementById('recommended-tracks-container');
             const histContainer = document.getElementById('history-tracks-container');
             
             // Simula√ß√£o de Recomenda√ß√£o por IA: as 5 primeiras faixas
             const recommendations = availableTracks.slice(0, 5);
             recContainer.innerHTML = '';
             recommendations.forEach(track => {
                 const card = document.createElement('div');
                 card.className = 'track-list-item';
                 card.innerHTML = `
                      <img src="${track.coverUrl}" alt="Capa" class="track-cover-small">
                      <div class="track-info" onclick="playTrackFromList('${track.id}', 'explore')">
                          <span class="track-title">${track.title}</span>
                          <span class="track-artist">${track.artist}</span>
                      </div>
                 `;
                 recContainer.appendChild(card);
             });
             
             // Hist√≥rico: as 5 faixas mais recentes (sem duplicatas)
             const uniqueHistoryIds = [...new Set(currentUser.history)].slice(0, 5);
             const historyTracks = uniqueHistoryIds.map(id => getTrackById(id)).filter(Boolean);
             
             histContainer.innerHTML = '';
             if (historyTracks.length > 0) {
                  renderTrackList(historyTracks, histContainer, false, 'history');
             } else {
                  histContainer.innerHTML = `<p style="color: var(--current-subtext-color);">Comece a ouvir para ver seu hist√≥rico aqui.</p>`;
             }
        }
        
        /**
         * Renderiza a se√ß√£o de M√∫sicas Curtidas.
         */
        function renderSection(sectionId) {
            switch(sectionId) {
                case 'liked-songs':
                    const likedTracks = allPlaylists[liked_songs_playlist_id].tracks;
                    // Note: A lista de curtidas permite remover (descurtir)
                    renderTrackList(likedTracks, document.getElementById('liked-songs-tracks-container'), true, liked_songs_playlist_id);
                    break;
                case 'library':
                    renderLibraryContent();
                    break;
            }
        }
        
        /**
         * Renderiza o conte√∫do principal da Biblioteca.
         */
        function renderLibraryContent() {
             const summaryContainer = document.getElementById('playlists-summary');
             summaryContainer.innerHTML = '';
             
             // Renderiza cards para as playlists
             const userPlaylists = Object.values(allPlaylists).filter(p => !p.isPredefined);
             userPlaylists.forEach(playlist => {
                 const card = document.createElement('div');
                 card.className = 'track-list-item';
                 card.onclick = () => viewPlaylist(playlist.id);
                 card.innerHTML = `
                     <div class="track-info">
                         <span class="material-icons" style="font-size: 2em; color: var(--color-primary);">queue_music</span>
                         <div class="track-details-text">
                             <span class="track-title">${playlist.name}</span>
                             <span class="track-artist">${playlist.tracks.length} ${playlist.tracks.length === 1 ? 'faixa' : 'faixas'}</span>
                         </div>
                     </div>
                 `;
                 summaryContainer.appendChild(card);
             });
             
             // Renderiza a visualiza√ß√£o filtrada (inicia com filtro por Artista)
             filterLibrary('artist');
        }

        /**
         * Visualiza o conte√∫do de uma playlist na se√ß√£o din√¢mica.
         * @param {string} playlistId - ID da playlist.
         */
        function viewPlaylist(playlistId) {
            const playlist = allPlaylists[playlistId];
            if (playlist) {
                 document.getElementById('current-playlist-title').textContent = playlist.name;
                 
                 // Define a fila de reprodu√ß√£o para esta playlist
                 currentPlaylistTracks = playlist.tracks;
                 currentPlaylistId = playlistId;

                 // Playlist de curtidas tem remo√ß√£o, mas com o bot√£o de cora√ß√£o (tratado em renderTrackList)
                 const allowRemove = playlist.id !== liked_songs_playlist_id;
                 
                 renderTrackList(playlist.tracks, document.getElementById('playlist-tracks-container'), allowRemove, playlistId);
                 showSection('playlist-view', playlistId);
            }
        }

        /**
         * Alterna a exibi√ß√£o do Flyout de Detalhes da M√∫sica (Capa Grande, Letras).
         */
        function toggleSongDetailsFlyout() {
             isFlyoutOpen = !isFlyoutOpen;
             songDetailsFlyout.style.display = isFlyoutOpen ? 'flex' : 'none';
             
             if (isFlyoutOpen && currentPlaylistTracks.length > 0) {
                 renderFlyoutDetails(currentPlaylistTracks[currentTrackIndex]);
             }
        }
        
        /**
         * Renderiza os detalhes da faixa no Flyout.
         * @param {object} track - Objeto da faixa.
         */
        function renderFlyoutDetails(track) {
             document.getElementById('flyout-cover').style.backgroundImage = `url(${track.coverUrl})`;
             document.getElementById('flyout-title').textContent = track.title;
             document.getElementById('flyout-artist').textContent = track.artist;
             
             // Simula√ß√£o de Letras Sincronizadas
             flyoutLyricsEl.innerHTML = '';
             if (track.lyrics) {
                 const [start, numLines, lyricContent] = track.lyrics;
                 // Simula√ß√£o de 10 linhas de letra
                 for (let i = 0; i < 10; i++) {
                      const line = document.createElement('p');
                      line.className = 'lyric-line';
                      // Adiciona um data-time para simula√ß√£o
                      line.dataset.time = (start + i * 5); // Cada linha muda a cada 5 segundos
                      line.textContent = `${lyricContent} (Linha ${i + 1})`;
                      flyoutLyricsEl.appendChild(line);
                 }
                 // Garante que a primeira linha est√° ativa
                 flyoutLyricsEl.querySelector('.lyric-line').classList.add('active');
             } else {
                 flyoutLyricsEl.innerHTML = `<p class="lyric-line active">Letra n√£o dispon√≠vel para esta faixa.</p>`;
             }
        }
        
        /**
         * Simula o destaque da linha da letra.
         * @param {number} currentTime - Posi√ß√£o atual da reprodu√ß√£o (em segundos).
         */
        function simulateLyricSync(currentTime) {
             const lines = flyoutLyricsEl.querySelectorAll('.lyric-line');
             let foundActive = false;
             
             lines.forEach(line => {
                 const lineTime = parseFloat(line.dataset.time);
                 
                 // Ativa a linha se o tempo atual for maior ou igual ao tempo da linha
                 if (currentTime >= lineTime && !foundActive) {
                     document.querySelector('.lyric-line.active')?.classList.remove('active');
                     line.classList.add('active');
                     
                     // Faz o scroll para manter a linha ativa vis√≠vel (simula√ß√£o)
                     line.scrollIntoView({ behavior: 'auto', block: 'center' });
                     
                     foundActive = true;
                 } else if (currentTime < lineTime) {
                     foundActive = true; // Impede que as linhas anteriores sejam reativadas
                 }
             });
        }


        // ----------------------------------------
        // 10. TEMAS E CONFIGURA√á√ïES
        // ----------------------------------------
        
        function openSettingsModal() {
             renderColorOptions(); // Renderiza as op√ß√µes de cor antes de abrir
             settingsModal.style.display = 'block';
        }

        function toggleThemeMode() {
             const newMode = themeSettings.mode === 'dark' ? 'light' : 'dark';
             themeSettings.mode = newMode;
             applyTheme();
        }
        
        function renderColorOptions() {
             const container = document.getElementById('color-options-container');
             container.innerHTML = '';
             
             Object.entries(accentColors).forEach(([name, hex]) => {
                 const option = document.createElement('div');
                 option.className = 'color-option';
                 option.style.backgroundColor = hex;
                 option.title = name;
                 option.dataset.colorHex = hex;
                 option.classList.toggle('selected', themeSettings.accentColor === hex);
                 
                 option.onclick = () => {
                     // Remove a sele√ß√£o anterior
                     document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                     // Adiciona a sele√ß√£o atual
                     option.classList.add('selected');
                     themeSettings.accentColor = hex;
                     applyTheme(); // Aplica imediatamente (pr√©-visualiza√ß√£o)
                 };
                 container.appendChild(option);
             });
             
             // Atualiza o bot√£o de altern√¢ncia do modo
             themeModeSwitch.textContent = themeSettings.mode === 'dark' ? 'Mudar para Claro' : 'Mudar para Escuro';
             themeModeSwitch.className = themeSettings.mode === 'dark' ? 'switch-dark' : 'switch-light';
        }

        function applyTheme() {
            // Aplica o modo
            document.body.classList.toggle('light-mode', themeSettings.mode === 'light');
            
            // Aplica a cor de acento
            document.documentElement.style.setProperty('--color-primary', themeSettings.accentColor);
            
            // Re-renderiza as op√ß√µes de cor para atualizar a sele√ß√£o
            renderColorOptions(); 
            
            // Se o Flyout estiver aberto, re-renderiza seus detalhes para o novo tema
            if (isFlyoutOpen) {
                 renderFlyoutDetails(currentPlaylistTracks[currentTrackIndex]);
            }
        }
        
        function saveThemeSettings() {
             saveState();
             settingsModal.style.display = 'none';
             alert("Configura√ß√µes de Tema salvas!");
        }
        
        // ----------------------------------------
        // 11. INICIALIZA√á√ÉO E SIMULA√á√ÉO PWA
        // ----------------------------------------

        function simulateDownload() {
             alert("Recurso de Download Offline (PWA) simulado!\nPara um aplicativo web progressivo real, voc√™ precisaria de um Service Worker e cache de API para armazenar o conte√∫do para uso offline.");
        }

        function initializeApp() {
             loadState();
             updateProfileUI();
             renderPlaylistsSidebar();
             renderHomeContent(); // Renderiza o conte√∫do inicial
             
             // Inicializa a primeira m√∫sica (se houver)
             if (availableTracks.length > 0) {
                 // Define a fila inicial como a biblioteca inteira
                 currentPlaylistTracks = [...availableTracks]; 
                 currentPlaylistId = 'explore';
                 loadTrack(currentPlaylistTracks[currentTrackIndex]);
             }

             // Escuta o evento de clique fora dos modais para fechar
             window.onclick = function(event) {
                 if (event.target == settingsModal) {
                     settingsModal.style.display = "none";
                 }
                 if (event.target == profileActionsModal) {
                     profileActionsModal.style.display = "none";
                 }
                 if (event.target == premiumModal) {
                     premiumModal.style.display = "none";
                 }
                 if (event.target == playlistSelectModal) {
                     playlistSelectModal.style.display = "none";
                 }
             }

             // Garante que o volume do player nativo √© definido no in√≠cio
             audioPlayer.volume = currentVolume;
        }

        initializeApp();
    </script>

</body>
</html>
